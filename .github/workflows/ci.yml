# This workflow runs tests on push and pull requests to the staging branch

name: CI

on:
  push:
    branches: [staging]
  pull_request:
    branches: [staging]

permissions:
  contents: read
  id-token: write # Required for OIDC

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [24.x]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install dependencies
        run: npm ci
      
      - name: Run migrations
        run: npm run migrations

      - name: Run Vitest
        run: npm run test:ci
        env:
          CHANNEL_ID: example
          SLACK_BOT_TOKEN: example
          SLACK_SIGNING_SECRET: example
          TURSO_AUTH_TOKEN: example
          TURSO_DATABASE_URL: file:./prisma/dev.db
          OPENAI_API_KEY: example
          API_KEY: test
